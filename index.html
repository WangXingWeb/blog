<!doctype html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>博客</title>

    <link href="comp/highlight/styles/pojoaque.css" rel="stylesheet">


    <link href="static/iconfont.css" rel="stylesheet">

    <link rel="stylesheet" href="comp/ydui/ydui.px.css">
    <script src="comp/marked.js"></script>
    <script src="comp/vue.js"></script>
    <script src="comp/highlight/highlight.pack.js"></script>
    <script src="comp/util.js"></script>
    <script src="comp/bmob-min.js"></script>
    <script src="comp/bmobMain.js"></script>
    <script src="comp/prompt.js"></script>
    <!--<script >hljs.initHighlightingOnLoad();</script>-->

    <!-- 引入组件库 -->
    <script src="comp/ydui/ydui.px.js"></script>

    <link href="static/editor/editor.css" rel="stylesheet">
    <link href="static/editor/editor-view.css" rel="stylesheet">
</head>
<body>
<div id="editor">
    <div class="editorArea">
        <div class="title-bar">
            <input type="text" @input="update" v-model="title"  placeholder="请输入题目">
        </div>
        <div class="tool-Bar">
            <div class="tool-Bar-loadImg" @click="loadImg">
                <input type="file" id="imgUpload" style="width: 0px;height: 0px;" value="上传" id="fileContainer" @change="getFile">
                <i class="icon iconfont icon-image"></i>
            </div>
            <button class="tool-Bar-save" type="hollow"  @click="save">保存</button>
        </div>
        <div class="editor-content">
            <textarea v-model="content"  @input="update" ></textarea>
        </div>
    </div>
    <div class="preview" v-html="dom"></div>
</div>
</body>
<script>

    marked.setOptions({
        highlight: function (code) {
            return hljs.highlightAuto(code).value;
        },
        gfm: true,
        tables: true,
        breaks: true,
        pedantic: false,
        sanitize: false,
        smartLists: true,
        smartypants: false
    });
    new Vue({
        el: '#editor',
        data: {
            dom: '',
            title:'',
            isSubmit:false,
            blogId:'',
            isCreated:false,
            content:''
        },
        created: function () {
            mainBmob.init();
        },
        methods: {
            update: function(e){
                this.dom="<center><h1>"+this.title+"</h1></center>"+marked(this.content);
                this.isSubmit=false;
            },
            loadImg:function (e) {
               document.getElementById("imgUpload").click();
            },
            save:function () {
                var _this=this;
                //必须添加标题和内容
                if(this.title&&this.dom){
                    //防止重复提交
                    if(!this.isSubmit){
                        this.isSubmit=true;
                        //新建
                        if(!this.isCreated){
                            mainBmob.addData({}, "Blog").then(function (data) {      //先创建一条数据
                                if(data.status){
                                    _this.blogId=data.objectId;                      //创建成功数据后修改数据
                                    _this.isCreated=true;
                                    return mainBmob.changeData({
                                        title:_this.title,
                                        content:_this.dom
                                    },"Blog",_this.blogId);
                                }else{                                               //创建失败
                                    toastX.call(_this,'保存失败',1);
                                }
                            }).then(function (data) {
                                toastX.call(_this,'保存成功',0);
                            });
                        //修改
                        }else{
                            mainBmob.changeData({
                                title:_this.title,
                                content:_this.dom
                            },"Blog",_this.blogId).then(function (data) {
                                toastX.call(_this,'保存成功',0);
                            })
                        }
                    }else{
                        toastX.call(_this,'您已提交，请勿重复提交',1);
                    }
                }else{
                    toastX.call(_this,'请添加题目和内容',0);
                }
            },
            getFile:function (e) {
                var _this=this;
                alert('正在上传，请稍等...');
                console.log(e);
                var fileImg = e.target.files[0];
                mainBmob.loadFile(fileImg.name,fileImg).then(function (data) {
                    if(data.status){
                        console.log(data.url);
                        _this.content+='![fileImg.name]('+data.url+')';
                        e.target.files[0]='';
                        _this.update();
                        alert('上传成功');
                    }else{
                        console.log(data.error);

                    }
                });

            }
        }
    });

</script>
</html>