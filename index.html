<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>

    <title>主页</title>
    <link rel="stylesheet" href="static/reset.css">
    <link rel="stylesheet" href="comp/mint-ui/mint-ui.css">
    <link rel="stylesheet" href="static/base.css">
    <link rel="stylesheet" href="static/iconfont.css">
    <link rel="stylesheet" href="component/wx-like-blog.css">

    <script src="comp/vue.js"></script>
    <script src="comp/util.js"></script>
    <script src="component/wx-blog.js"></script>
    <script src="component/wx-like-blog.js"></script>
    <script src="comp/mint-ui/mint-ui.js"></script>

    <script src="comp/bmob-min.js"></script>
    <script src="comp/bmobMain.js"></script>

</head>
<style>
    .page-tabbar {
        overflow: hidden;
        height: 100vh;
    }
    .page-wrap {
        overflow: auto;
        height: 100%;
        padding-bottom: 100px;
    }
    .content{
        margin: 40px 0 80px;
    }
    .mint-tabbar>.mint-tab-item.is-selected{
        background-color: #fafafa;
    }
    .mint-tabbar{
        background-image: none;
    }
    .mint-tabbar>.mint-tab-item.is-selected .mint-tab-item-label{
        color:#dc4036;
    }
    .mint-tab-item-label{
        color:#707070;
    }
    .await{
        text-align: center;
        color: #999;
        font-size: 18px;
        line-height: 100px;
        font-weight: 800;
    }
    .img-contianer {
        background-repeat: no-repeat;
        background-size: cover;
        background-position: center;
        background-color: #666;
        float: left;
        margin-right: 10px;
        width: 70px;
        height: 70px;
    }
    .wx-header-title{
        padding: 5px 0;
        margin: 0px 12px;
    }
    .wx-header-title-active{
        font-weight: 800;
        border-bottom: 2px solid #fff;
        margin-bottom: -2px;
    }
</style>
<body>
<div id="blogList">
    <div class="page-tabbar">
        <div class="page-wrap">
            <mt-tab-container class="page-tabbar-container content" v-model="selected">
                <mt-tab-container-item id="0">
                    <mt-header fixed  :title="selectedTitle" class="wx-header">
                        <mt-button icon="back" slot="left">返回</mt-button>
                        <mt-button v-on:click="createNew" slot="right">新建笔记 +</mt-button>
                    </mt-header>
                    <ul class="blogList">
                        <wx-blog  v-for="blog in selfBlogs" :key="blog.id" :blogdata="blog"></wx-blog>
                    </ul>
                </mt-tab-container-item>

                <mt-tab-container-item id="1">
                    <header class="mint-header wx-header is-fixed">
                        <div class="mint-header-button is-left">
                            <button class="mint-button mint-button--default mint-button--normal">
                                <span class="mint-button-icon">
                                    <i class="mintui mintui-back"></i>
                                </span>
                                <label class="mint-button-text">返回</label>
                            </button>
                        </div>
                        <div class="wx-header-title" v-bind:class="{ 'wx-header-title-active':isActiveLike }" @click="switchActive(0)">关注</div>
                        <div class="wx-header-title" v-bind:class="{ 'wx-header-title-active':isActiveRecommend }" @click="switchActive(1)">热门</div>
                        <div class="mint-header-button is-right" @click="createNew">
                            <button class="mint-button mint-button--default mint-button--normal">
                                <label class="mint-button-text">新建笔记 +</label>
                            </button>
                        </div>
                    </header>
                    <div v-if="isActiveLike">
                        <ul class="blogList">
                            <wx-like-blog v-for="dynamic in dynamicBlogs" :dynamic="dynamic"></wx-like-blog>
                        </ul>
                    </div>
                    <div v-else>
                        <ul class="blogList">
                            <li class="like-blog">
                                <div class="like-header">
                                    <div class="like-headImg-container">
                                        <img alt="" class="like-headImg">
                                    </div>
                                    <div class="like-type-name">
                                        <div class="like-name">晶晶 </div>
                                    </div>
                                    <div class="like-time">2018.07.31 15:37</div>
                                </div><div class="like-content">
                                <div class="like-title">今天去看一下装修进度</div>
                                <div class="like-content-main">
                                    <div class="like-info">天气很热</div>
                                    <div class="like-content-img" style="background: url(&quot;http://bmob-cdn-20127.b0.upaiyun.com/2018/07/28/87b47c2140f4ddcd80aff9755996e0d2.jpg&quot;);"></div>
                                </div>
                            </div>
                            <div class="like-footer">
                                <div class="like-footer-left">
                                    <div class="like-num">
                                        <span>0</span>
                                        <i class="icon iconfont icon-dianzan1"></i>
                                    </div>
                                    <div class="like-num">
                                        <span>0</span>
                                        <i class="icon iconfont icon-pinglun"></i>
                                    </div>
                                </div>
                                <i class="icon iconfont icon-gengduo"></i>
                            </div>
                            </li>
                        </ul>
                    </div>

                </mt-tab-container-item>
                <mt-tab-container-item id="2">
                    <mt-header fixed  :title="selectedTitle" class="wx-header">
                        <mt-button icon="back" slot="left">返回</mt-button>
                        <mt-button v-on:click="createNew" slot="right">新建笔记 +</mt-button>
                    </mt-header>
                    <div class="await">内测版本，待开发</div>
                </mt-tab-container-item>
                <mt-tab-container-item id="3">
                    <div class="await">内测版本，待开发</div>
                </mt-tab-container-item>
                <mt-tab-container-item id="4">
                    <div class="await">内测版本，待开发</div>
                </mt-tab-container-item>

            </mt-tab-container>
        </div>
        <!--tabbar-->
        <mt-tabbar v-model="selected" fixed>
            <mt-tab-item id="0">
                <img slot="icon" v-if="selected==0" src="images/blog-active.png">
                <img slot="icon" v-else src="images/blog.png">
                我的笔记
            </mt-tab-item>
            <mt-tab-item id="1">
                <img slot="icon" v-if="selected==1" src="images/discover-active.png">
                <img slot="icon" v-else src="images/discover.png">
                发现
            </mt-tab-item>
            <mt-tab-item id="2">
                <img slot="icon" v-if="selected==2" src="images/mine-active.png">
                <img slot="icon" v-else src="images/mine.png">
                我的
            </mt-tab-item>
            <!--<mt-tab-item id="3">
                <img slot="icon"  v-if="selected==3" src="images/mine-active.png">
                <img slot="icon" v-else src="images/mine.png">
                消息
            </mt-tab-item>
            <mt-tab-item id="4">
                <img slot="icon" v-if="selected==4" src="images/mine-active.png">
                <img slot="icon" v-else src="images/mine.png">
                我的
            </mt-tab-item>-->
        </mt-tabbar>
    </div>
</div>
</body>
<script>
    new Vue({
        el:"#blogList",
        data: {
            selected:"0",
            selectedTitle:'',
            selfBlogs:[],
            openBlogs:[],
            dynamicBlogs:[],
            user:{},
            isActiveLike:true,
            isActiveRecommend:false
        },
        created:function () {
            mainBmob.init();
            var currentUser = Bmob.User.current();
            this.user=currentUser;
            this.selectedTitle=this.user.attributes.username;
            this.getSelfList();
        },
        watch:{
            selected:function () {
                if(this.selected==0){
                    this.getSelfList();
                    this.selectedTitle=this.user.attributes.username;
                }else if(this.selected==1){
                    this.selectedTitle='发现';
                    /*获取关注动态*/
                    this.getDynamic();
                    //this.getOpenList();

                }else{
                    this.selectedTitle='我的';
                }
            }
        },
        methods:{
            getSelfList:function () {
                var _this=this;
                if(_this.user){
                    this.$indicator.open();
                    mainBmob.equalTo('Blog',{author:_this.user.id}).then(function (data) {
                        if(data.code==200){
                            _this.selfBlogs=data.list;
                            console.log(data.list);
                            _this.$indicator.close();
                        }else{
                            console.log(data.error.code+data.error.message);
                        }
                    });
                    _this.$indicator.close();
                }else{
                    window.location.href='login.html';
                }

            },
            getOpenList:function () {
                var _this=this;
                if(_this.user){
                    this.$indicator.open();
                    mainBmob.equalTo('Blog',{'open':true}).then(function (data) {
                        if(data.code==200){
                            _this.openBlogs=data.list;
                            console.log(data.list);
                            _this.$indicator.close();
                        }else{
                            console.log(data.error.code+data.error.message);
                        }
                    });
                    _this.$indicator.close();
                }else{
                    window.location.href='login.html';
                }
            },

            createNew:function () {
                window.location.href = 'create.html';
            },
            switchActive:function (data) {
                if(data==0){
                    this.isActiveLike=true;
                    this.isActiveRecommend=false;
                }else{
                    this.isActiveLike=false;
                    this.isActiveRecommend=true;
                }
            },
            getDynamic:function () {
                var _this=this;
                if(_this.user){
                    this.$indicator.open();
                    console.log(_this.user.id);
                    //查关系表获取到用户关注的人的列表
                    mainBmob.equalTo('Attention',{'user':_this.user.id}).then(function (data) {
                        if(data.code==200){
                            console.log(data.list);
                            var list=data.list;
                            var arr=[];
                            for(var i=0;i<list.length;i++){
                                arr.push(list[i].attributes.attented);
                            }
                            return mainBmob.queryMultipleData('Dynamic','user',arr);
                        }else{
                            console.log(data.error.code+data.error.message);
                            _this.$messagebox('获取数据错误', '请确认您的网络是否通畅');
                        }
                    }).then(function (data) {
                        if(data.code==200){
                            console.log(data.list);
                            _this.dynamicBlogs=data.list;
                            _this.$indicator.close();
                        }else{
                            _this.$messagebox('获取数据错误', '请确认您的网络是否通畅');
                        }
                    });
                    _this.$indicator.close();
                }else{
                    window.location.href='login.html';
                }
            }
        }
    });
</script>
</html>