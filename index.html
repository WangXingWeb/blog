<!doctype html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>博客</title>

    <link href="comp/highlight/styles/ocean.css" rel="stylesheet">
    <link href="static/editor/editor.css" rel="stylesheet">
    <link href="static/editor/editor-view.css" rel="stylesheet">
    <link href="static/iconfont.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">


    <script src="comp/marked.js"></script>
    <script src="comp/vue.js"></script>
    <script src="comp/highlight/highlight.pack.js"></script>
    <script src="comp/util.js"></script>
    <script src="comp/bmob-min.js"></script>
    <script src="comp/bmobMain.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <!--<script >hljs.initHighlightingOnLoad();</script>-->
</head>
<body>
<div id="editor">
    <div class="editorArea">
        <div class="title-bar">
            <input class="title" type="text" placeholder="请输入题目" @input="updateTitle">
        </div>
        <div class="tool-Bar">
            <div class="tool-Bar-loadImg" @click="loadImg"><i class="icon iconfont icon-image"></i></div>
            <button class="tool-Bar-save" @click="save">保存</button>
        </div>
        <div class="editor-content">
            <textarea  @input="update"></textarea>
        </div>

    </div>
    <div v-html="compiledMarkdown" class="preview"></div>
</div>
</body>
<script>

    marked.setOptions({
        highlight: function (code) {
            return hljs.highlightAuto(code).value;
        },
        gfm: true,
        tables: true,
        breaks: true,
        pedantic: false,
        sanitize: false,
        smartLists: true,
        smartypants: false
    });
    new Vue({
        el: '#editor',
        data: {
            dom: '',
            title:'',
            isSubmit:false,
            blogId:'',
            isCreated:false
        },
        computed: {
            compiledMarkdown: function () {
                return "<center><h1>"+this.title+"</h1></center>"+this.dom;
            }
        },
        methods: {
            updateTitle:function(e){
                this.title=e.target.value;
                this.isSubmit=false;
            },
            update: function(e){
                this.dom=marked(e.target.value);
                this.isSubmit=false;
            },
            loadImg:function () {
                console.log(1323);
            },
            save:function () {
                var _this=this;
                //必须添加标题和内容
                if(this.title&&this.dom){
                    //防止重复提交
                    if(!this.isSubmit){
                        this.isSubmit=true;
                        //新建
                        if(!this.isCreated){
                            mainBmob.init();
                            mainBmob.addData({}, "Blog").then(function (data) {
                                if(data.status){
                                    _this.blogId=data.objectId;
                                    console.log(_this.blogId);
                                    _this.isCreated=true;
                                    return mainBmob.changeData({
                                        title:_this.title,
                                        content:_this.dom
                                    },"Blog",_this.blogId);
                                }else{
                                    console.log('保存失败'+data.objError);
                                }
                            }).then(function (data) {
                                console.log(data);
                            });
                        //修改
                        }else{
                            mainBmob.changeData({
                                title:_this.title,
                                content:_this.dom
                            },"Blog",_this.blogId).then(function (data) {
                                console.log(data);
                            })
                        }
                    }else{
                        console.log('您已提交请勿重复提交');
                    }
                }else{
                    console.log('请添加题目和内容');
                }
            }
        }
    });

</script>
</html>